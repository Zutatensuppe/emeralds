function base64ToArrayBuffer(e){for(var t=atob(e.substr(e.indexOf(",")+1)),n=t.length,o=new Uint8Array(n),r=0;n>r;r++)o[r]=t.charCodeAt(r);return o.buffer}function Sequencer(e){function t(e,t){if(n.isMuted)console.log("nothing");else{var o=i.createBufferSource(),r=u[e.n||e];o.playbackRate.value=e.p||1,o.buffer=r,o.connect(i.destination);var f=t||0;o.start(f)}}var n=this,o=0,r=0,i=new(window.AudioContext||webkitAudioContext);n.buffer=e.buffer||.2,n.loopSpeed=e.loopSpeed;var u,f,a;this.initLoops=function(e){u={},Object.keys(e.instruments).forEach(function(t){i.decodeAudioData(base64ToArrayBuffer(e.instruments[t]),function(e){console.log("Setting",t,e),u[t]=e})}),f=e.song,f=f.map(function(t,n){var o=[];return t.forEach(function(t){var r=e.loops[t];if(e.instruments[t.n||t])o.push(t);else if(r){o=o.concat(r[0]);for(var i=1;i<r.length;i++)f[n+i]=f[n+i].concat(r[i])}}),o})},this.initLoops(e),this.mute=function(e){this.isMuted=e},this.play=function(){var n,u=this;return u.interval=setInterval(function(){a||(a=i.currentTime);for(var s=0;100>s;s++){var l=f[o];if(o>=f.length)e.loop?(o=0,r++):u.stop(),e.onComplete&&e.onComplete();else{var c=a+(u.loopSpeed*o+f.length*r*u.loopSpeed)/1e3;if(c>i.currentTime+u.buffer){console.log("Buffer full");break}for(n=0;n<l.length;n++)t(l[n],c);o++}}},500*this.buffer),u},this.stop=function(){var e=this;return e.interval&&(clearInterval(e.interval),e.interval=!1),o=0,a=i.currentTime,e}}"undefined"!=typeof module&&(module.exports=Sequencer);