function base64ToArrayBuffer(e){for(var n=atob(e.substr(e.indexOf(",")+1)),t=n.length,o=new Uint8Array(t),r=0;t>r;r++)o[r]=n.charCodeAt(r);return o.buffer}function Sequencer(e){function n(e,n){var o=a.createBufferSource(),r=c[e.n||e];o.playbackRate.value=e.p||1,o.buffer=r,o.connect(i),o.start(n||0),t.c.push(o),o.onended=function(e){t.c.forEach(function(n,t,o){return n===e.srcElement?(o.splice(t,1),!1):void 0})}}var t=this,o=0,r=0,a=new(window.AudioContext||webkitAudioContext);t.a=e.buffer||.2,t.b=e.loopSpeed;var i=a.createGain();i.connect(a.destination);var u=null;this.c=[];var c,f,s;this.initLoops=function(e){c={},Object.keys(e.instruments).forEach(function(n){a.decodeAudioData(base64ToArrayBuffer(e.instruments[n]),function(e){console.log("Setting",n,e),c[n]=e})}),f=e.song,f=f.map(function(n,t){var o=[];return n.forEach(function(n){var r=e.loops[n];if(e.instruments[n.n||n])o.push(n);else if(r){o=o.concat(r[0]);for(var a=1;a<r.length;a++)f[t+a]=f[t+a].concat(r[a])}}),o})},this.initLoops(e),this.mute=function(e){e?(u&&clearInterval(u),i.gain.value=0):u=setInterval(function(){i.gain.value+=.1,i.gain.value>=1&&(i.gain.value=1,clearInterval(u),u=null)},100)},this.play=function(){var t,i=this;return i.d=setInterval(function(){s||(s=a.currentTime);for(var u=0;100>u;u++){var c=f[o];if(o>=f.length){if(e.loop){o=0,r++,e.onComplete&&e.onComplete();continue}i.stop(!0),e.onComplete&&e.onComplete();break}var l=s+(i.b*o+f.length*r*i.b)/1e3;if(l>a.currentTime+i.a)break;for(t=0;t<c.length;t++)n(c[t],l);o++}},500*this.a),i},this.stop=function(e){var n=this;return n.d&&(clearInterval(n.d),n.d=!1),e||n.c.forEach(function(e){e.stop()}),n.c=[],o=0,s=a.currentTime,n}}"undefined"!=typeof module&&(module.exports=Sequencer);