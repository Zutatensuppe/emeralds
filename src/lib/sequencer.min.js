function base64ToArrayBuffer(e){for(var n=atob(e.substr(e.indexOf(",")+1)),t=n.length,r=new Uint8Array(t),o=0;t>o;o++)r[o]=n.charCodeAt(o);return r.buffer}function Sequencer(e){function n(e,n){var r=u.createBufferSource(),o=c[e.n||e];r.playbackRate.value=e.p||1,r.buffer=o,r.connect(i),r.start(n||0),t.currentSources.push(r),r.onended=function(e){t.currentSources.forEach(function(n,t,r){return n===e.srcElement?(r.splice(t,1),!1):void 0})}}var t=this,r=0,o=0,u=new(window.AudioContext||webkitAudioContext);t.buffer=e.buffer||.2,t.loopSpeed=e.loopSpeed;var i=u.createGain();i.connect(u.destination);var a=null;this.currentSources=[];var c,f,l;this.initLoops=function(e){c={},Object.keys(e.instruments).forEach(function(n){u.decodeAudioData(base64ToArrayBuffer(e.instruments[n]),function(e){console.log("Setting",n,e),c[n]=e})}),f=e.song,f=f.map(function(n,t){var r=[];return n.forEach(function(n){var o=e.loops[n];if(e.instruments[n.n||n])r.push(n);else if(o){r=r.concat(o[0]);for(var u=1;u<o.length;u++)f[t+u]=f[t+u].concat(o[u])}}),r})},this.initLoops(e),this.mute=function(e){this.isMuted=e,e?(a&&clearInterval(a),i.gain.value=0):a=setInterval(function(){i.gain.value+=.1,i.gain.value>=1&&(i.gain.value=1,clearInterval(a),a=null)},100)},this.play=function(){var t,i=this;return i.interval=setInterval(function(){l||(l=u.currentTime);for(var a=0;100>a;a++){var c=f[r];if(r>=f.length){if(console.log(f.length),e.loop){r=0,o++,e.onComplete&&e.onComplete();continue}i.stop(!0),e.onComplete&&e.onComplete();break}var s=l+(i.loopSpeed*r+f.length*o*i.loopSpeed)/1e3;if(s>u.currentTime+i.buffer)break;for(t=0;t<c.length;t++)n(c[t],s);r++}},500*this.buffer),i},this.stop=function(e){var n=this;return n.interval&&(clearInterval(n.interval),n.interval=!1),e||n.currentSources.forEach(function(e){e.stop()}),n.currentSources=[],r=0,l=u.currentTime,n}}"undefined"!=typeof module&&(module.exports=Sequencer);